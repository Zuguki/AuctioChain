var j=Object.defineProperty;var F=(a,t,s)=>t in a?j(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var i=(a,t,s)=>(F(a,typeof t!="symbol"?t+"":t,s),s);import{l as k,m as S,n as g,q as u,g as R,t as U,v as C,w as I,o as N,r as h,C as A,j as e,F as $,L as _,B as E,x as T,y as P,$ as B,z as w,A as L}from"./index-de2d1123.js";import{u as M,F as D,n as q}from"./useDataUser-7a2b0287.js";import{u as V,r as f}from"./mathOperations-97aa884d.js";import{u as O}from"./useQuery-baed50f9.js";import"./utils-73056672.js";const Y="_position_16t0c_1",W="_positionAddWallet_16t0c_5",G="_title_16t0c_9",H="_balance_16t0c_14",K="_fox_16t0c_19",z="_attention_16t0c_25",J="_bill_16t0c_31",Q="_titleBlock_16t0c_38",X="_panels_16t0c_42",b={position:Y,positionAddWallet:W,title:G,balance:H,fox:K,attention:z,bill:J,titleBlock:Q,panels:X},c=class c{static async handleClickMetamask(){try{const[t]=await c.web3Provider.send("eth_requestAccounts",[]);g.bill=t,u.setToStorage(u.BILL,t)}catch(t){alert("He удалось подключить кошлёк!"),console.log(t)}}static async sendEth(t){try{const s=g.bill;if(!s){alert("Кошлек не подключён к сайту!");return}const[n]=await c.web3Provider.send("eth_requestAccounts",[]);if(n!==s){alert("Невозможно выполнить транзакцию! Проверьте номер кошлека в MetaMask!");return}const r=await c.web3Provider.getSigner(),o=c.contract.connect(r);await R.postBalance(r.address),await o.getFunction("payForItem").send({value:U(t)}),u.setProcessAddMoney(!0);const p=await this.requestUserMoney();if(!p){alert("Невозможно получить данные о балансе! Уведомления не будут отображаться!");return}return u.startLoadingTransaction(p),C.notification=I,await this.getUserMoney()}catch(s){console.log(JSON.stringify(s,null,4)),alert(`Ошибка транзакции! ${s}`);return}}static async getUserMoney(){const t=u.getToStorage(u.PREV_BALANCE);return new Promise(s=>{const n=setInterval(async()=>{const r=await this.requestUserMoney();if(!t||!r){alert("Ошибка транзакции!");return}t<r&&(clearInterval(n),s(Number(r-t)/Math.pow(10,14)))},1e4)})}static async requestUserMoney(){try{const t=await c.web3Provider.getSigner(),s=await c.contract.getUserBalance(t.address);return Number(s)}catch{console.log("requestUserMoney err")}}};i(c,"contractAddress",{}.BILL_KEY??"0x524043c049c5bDEdEB9A6014bc11Db4cA9dBDBD0"),i(c,"contractABI",[{inputs:[],name:"payForItem",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"address",name:"userAddress",type:"address"}],name:"removeUserFromMap",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],stateMutability:"nonpayable",type:"constructor"},{inputs:[{internalType:"address",name:"userAddress",type:"address"}],name:"getUserBalance",outputs:[{internalType:"uint256",name:"result",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"payments",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}]),i(c,"web3Provider",new k(window.ethereum)),i(c,"contract",new S(c.contractAddress,c.contractABI,c.web3Provider));let x=c;const Z="_positionFormEth_179kn_1",tt="_textTitle_179kn_11",et="_currency_179kn_16",st="_buttonChangeForm_179kn_23",y={positionFormEth:Z,textTitle:tt,currency:et,buttonChangeForm:st},at=()=>({}),nt="/assets/changeStateForm-a58220d9.svg",rt=_.ValueAc,ct=N(()=>{const{rubEth:a}=V(),{dataUser:{eph:t},logicFormValue:s}=M(),{stateApp:n}=h.useContext(A),[r,o]=h.useState("add"),p=async()=>{switch((Number.isNaN(+t)||+t<=0)&&alert("Некорректное значение!"),r){case"add":{const m=await x.sendEth(t);u.endLoadingTransaction(),m&&(n.notification=T(m));break}case"takeOf":alert("недоступно!")}},v=()=>{o(m=>{switch(m){case"add":return"takeOf";case"takeOf":return"add";default:return"add"}})};return e.jsxs($,{onSubmit:p,className:y.positionFormEth,children:[e.jsx("h2",{className:y.textTitle,children:r==="add"?"Пополнение:":"Снятие:"}),e.jsx("button",{type:"button",className:y.buttonChangeForm,onClick:v,children:e.jsx("img",{src:nt,alt:"change-state"})}),e.jsx(D,{title:`Количество (${_.Eth}) на ${r==="add"?"пополнение:":"снятие:"}`,name:"eph",type:"number",min:1e-6,step:1e-6,blockChars:q,error:null,changeValue:m=>s(m),errorBlur:at}),t&&!Number.isNaN(+t)&&e.jsxs("div",{children:[e.jsxs("p",{className:y.currency,children:[_.Rub,": ",f(+t*a)]}),e.jsxs("p",{className:y.currency,children:[_.Ac,": ",f(+t*rt)]})]}),e.jsx(E,{type:"submit",disabled:n.notification!==null,children:r==="add"?"Пополнить":"Снять"})]})}),ot="_background_motwb_1",it="_positionBlock_motwb_9",lt="_text_motwb_14",ut="_balance_motwb_19",dt="_balanceRub_motwb_25",pt="_title_motwb_29",l={background:ot,positionBlock:it,text:lt,balance:ut,balanceRub:dt,title:pt},{API_URL_CURRENCY:mt,API_KEY_CURRENCY:bt}={BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1},ht=bt??"71972f41cf2f210b2a882f5304801376948d23906c885bdc32ab256fa40ec4b2",yt=mt??"https://min-api.cryptocompare.com/data/",_t=()=>{const[a,t]=h.useState(0),[s,n]=h.useState(!1),r=async()=>{n(()=>!0);const{data:o}=await P.get(`${yt}price?fsym=ETH&tsyms=RUB&api_key=${ht}`);t(()=>o.RUB),n(()=>!1)};return h.useEffect(()=>{let o;return r(),(async()=>o=setInterval(async()=>r(),1e4))(),()=>clearInterval(o)},[]),{rubEth:a,isLoading:s}},xt=(a,t,s={})=>{const{data:n,isSuccess:r,isLoading:o,error:p}=O({queryKey:t,queryFn:()=>a(),retry:3,staleTime:1e3});return{data:(n==null?void 0:n.data)??s,isLoading:o,isSuccess:r,error:p,headers:n==null?void 0:n.headers}};class ft{constructor(){i(this,"pathBalance","balance")}async getBalanceUser(){return B.get(`${this.pathBalance}`)}async postBalance(t){return B.post(`${this.pathBalance}`,{walletAddress:t})}}const gt=new ft,Bt=({form:a=!1,...t})=>e.jsx("div",{className:`spinner-border text-primary ${a?w.spinnerForm:w.spinner}`,...t,role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})});class d{}i(d,"Eth","ETH"),i(d,"Rub","RUB"),i(d,"Ac","Ac"),i(d,"ValueAc",Math.pow(10,4));const wt=({bill:a})=>{const{rubEth:t,isLoading:s}=_t(),{data:{balance:n},isLoading:r}=xt(()=>gt.getBalanceUser(),["balance"]),o=!s&&!r;return e.jsxs("div",{className:l.background,children:[e.jsxs("div",{className:l.positionBlock,children:[e.jsx("h2",{className:l.title,children:"Баланс:"}),o?e.jsxs("p",{className:l.balance,children:[n," ",d.Ac,e.jsxs("span",{className:l.balanceRub,children:[" ≈ ",f(n*t/d.ValueAc).toFixed(2)," ",d.Rub]})]}):e.jsx(Bt,{style:{margin:0},form:!0})]}),e.jsxs("div",{className:l.positionBlock,children:[e.jsx("h2",{className:l.title,children:"Кошлёк:"}),e.jsx("p",{className:l.text,children:a})]})]})},kt=N(()=>{const{userStore:a}=h.useContext(A),t=a.bill;return e.jsxs("div",{className:b.position,children:[e.jsxs("div",{className:b.titleBlock,children:[e.jsx("h1",{className:b.title,children:"Манипуляции со счётом"}),e.jsx("img",{src:L,className:b.fox,alt:"meta-fox"})]}),e.jsx("div",{className:b.positionAddWallet,children:e.jsx(E,{onClick:x.handleClickMetamask,children:t?"Обновить кошлёк":"Подключение кошелька"})}),t&&e.jsxs("div",{className:b.panels,children:[e.jsx(wt,{bill:t}),e.jsx(ct,{})]})]})});export{kt as default};
